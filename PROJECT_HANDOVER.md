# 📘 사전영업 데이터 분석 대시보드 프로젝트 인수인계 문서

본 문서는 '사전영업 대시보드' 프로젝트의 현재 상태, 구현된 기능, 기술적 난관 및 해결 방법, 그리고 향후 작업을 다른 AI 에이전트나 개발자가 원활하게 이어받을 수 있도록 작성되었습니다.

---

## 1. 프로젝트 개요

- **프로젝트명**: 사전영업 데이터 분석 대시보드
- **목적**: 사전영업 단계에서 수집된 설문 데이터를 시각화하고 분석하여, 의사결정에 필요한 인사이트를 제공하며, 분석 결과를 엑셀 보고서 형태로 자동 생성하여 공유할 수 있게 함.
- **주요 기능**: 
  - 핵심 지표(KPI) 대시보드
  - 설문 문항별 상세 차트 분석
  - 다차원 데이터 필터링 (지역, 담당자, 등급 등)
  - **상세 엑셀 보고서 자동 생성 및 다운로드 (핵심)**

## 2. 기술 스택 및 환경

- **언어**: Python 3.10+
- **웹 프레임워크**: Streamlit
- **데이터 처리**: Pandas
- **시각화**: Plotly Express
- **엑셀 생성**: XlsxWriter
- **이미지 변환**: Kaleido (Plotly 차트를 이미지로 변환)
- **이미지 처리**: Pillow (PIL)

### 필수 라이브러리 (`requirements.txt`)
```text
streamlit
pandas
plotly
xlsxwriter
kaleido
pillow
```

## 3. 프로젝트 파일 구조

```
d:\AI프로그램제작\사전영업대시보드\
├── app_dashboard.py            # 메인 대시보드 애플리케이션 (Entry Point)
├── excel_report_generator.py   # 엑셀 보고서 생성 로직 모듈 (핵심)
├── test_excel_generation.py    # 엑셀 생성 기능 독립 테스트 스크립트
├── requirements.txt            # 의존성 패키지 목록
└── .gitignore                  # Git 무시 설정
```

## 4. 핵심 기능 구현 상세

### 4.1. 엑셀 보고서 생성 (`excel_report_generator.py`)

이 모듈은 Pandas DataFrame을 입력받아 서식이 지정된 엑셀 파일(`BytesIO`)을 반환합니다.

- **구성 요소**:
  - `_create_formats`: 엑셀 스타일(헤더, 셀, 숫자, 백분율 등) 정의.
  - `_add_raw_data_sheet`: 원본 데이터 시트 생성. 조건부 서식(Grade 별 색상), 필터, 틀 고정 적용.
  - `_add_summary_sheet`: 통계 요약 시트 생성. 문항별 응답 수 및 비율 테이블 자동 생성.
  - `_add_charts_sheet`: **Plotly 차트를 이미지로 변환하여 엑셀에 삽입.**
    - `kaleido` 엔진을 사용하여 차트를 PNG로 변환.
    - 변환 실패 시 텍스트 정보로 대체하는 안전 장치 포함.
    - 차트 배치 간격을 10칸(열)으로 설정하여 겹침 방지.
    - 파스텔 톤 색상 및 그라데이션 적용.

### 4.2. 엑셀 다운로드 프로세스 (`app_dashboard.py`)

Streamlit의 특성(Re-run)으로 인한 다운로드 오류를 방지하기 위해 **2단계 프로세스**를 구현했습니다.

1.  **보고서 생성 (`📥 엑셀 보고서 생성` 버튼)**:
    - 사용자가 버튼 클릭 시 보고서를 생성합니다.
    - 생성된 파일 객체(`BytesIO`)에서 **`getvalue()`를 호출하여 `bytes` 데이터만 추출**합니다.
    - 추출한 `bytes` 데이터와 생성된 파일명을 `st.session_state`에 저장합니다.
    - *이유: 객체 자체를 저장하면 상태 리셋 시 포인터가 유실되어 파일이 깨짐.*

2.  **파일 다운로드 (`⬇️ 엑셀 파일 다운로드` 버튼)**:
    - `st.session_state`에 저장된 데이터가 있을 때만 버튼이 표시됩니다.
    - 버튼의 `key`를 `f"dl_{filename}"` 형식으로 **동적 할당**합니다.
    - *이유: 이전 캐시된 버튼이 재사용되어 잘못된 파일이 다운로드되는 것을 막기 위함.*

## 5. 트러블슈팅 이력 (중요 Reference)

이 프로젝트를 진행하면서 해결한 주요 이슈들입니다. 향후 유지보수 시 참고하십시오.

### 이슈 1: 다운로드된 엑셀 파일이 열리지 않음 / 파일명이 UUID로 깨짐
- **원인**: `st.download_button`에 `BytesIO` 객체를 직접 전달했으나, 스트림 포지션이 초기화되거나 객체가 소실됨.
- **해결**:
  - `generate_excel_report`의 반환값(`BytesIO`)에서 `.getvalue()`로 순수한 `bytes` 데이터 추출.
  - `st.session_state`에 `bytes` 데이터를 저장하고 다운로드 버튼에 전달.
  - `mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"` 명시.

### 이슈 2: 다운로드 버튼 클릭 시 동작 안 함 (재실행 문제)
- **원인**: Streamlit은 버튼 클릭 시 전체 스크립트를 재실행하는데, 중첩된 버튼 구조에서 로직이 끊김.
- **해결**: "생성"과 "다운로드"를 분리하고, 생성된 데이터를 세션 상태(`st.session_state`)에 영속적으로 저장하여 재실행 후에도 다운로드 버튼이 유지되도록 함.

### 이슈 3: 차트 이미지가 엑셀에서 겹쳐 보임
- **원인**: 엑셀 셀 너비에 비해 삽입된 이미지(600x400)가 커서, 기본 간격(3열)으로는 이미지가 겹침.
- **해결**: 차트 배치 간격을 **10열(Column)**로 대폭 확대하고, 2개 배치 후 줄바꿈하도록 로직 수정.

### 이슈 4: 차트가 흑백으로 나옴
- **원인**: Plotly 기본 템플릿 정보가 `kaleido` 변환 시 완벽하게 전달되지 않음.
- **해결**: 차트 생성 함수(`px.pie`, `px.bar`)에 `color`, `color_discrete_sequence` 속성을 명시적으로 추가하여 파스텔 톤 및 그라데이션 적용.

### 이슈 5: Q7, Q8 차트 누락
- **원인**: 초기 개발 시 Q6까지만 구현됨.
- **해결**: `excel_report_generator.py`에 Q7(청약 자격), Q8(희망 분양가) 차트 생성 로직을 추가하고 색상 테마 적용.

### 이슈 6: 차트 생성 실패 시 엑셀 파일 전체 생성 실패
- **원인**: `kaleido` 설치 문제 등으로 차트 변환 실패 시 예외가 발생하여 파일 생성이 중단됨.
- **해결**: 다중 `try-except` 블록 적용. 차트 이미지 변환 실패 시 해당 부분을 **텍스트 요약 정보로 대체**하고, 파일 생성 자체는 성공하도록 이중 안전 장치 마련.

## 6. 향후 작업 계획 (Next Steps)

현재 엑셀 보고서 기능은 완벽하게 구현되었습니다. 다음 단계는 AI 분석 기능을 고도화하는 것입니다.

### 6.1. AI 인사이트 분석 기능
- **목표**: 수집된 데이터를 LLM(Google Gemini 등)에 전달하여 정성적 분석 결과를 도출.
- **구현 아이디어**:
  - `app_dashboard.py`에 "AI 분석 리포트" 탭 추가.
  - 현재 필터링된 데이터의 요약 통계(JSON 형태 변환)를 프롬프트에 포함.
  - "이 지역의 주요 고객층 특징은 무엇인가?", "마케팅 소구 포인트는?" 등의 질문에 답변 생성.
  - 생성된 텍스트 분석 결과를 엑셀 보고서의 새로운 시트('AI 분석')에 추가하는 기능 확장.

### 6.2. 엑셀 보고서 고도화
- **차트 커스터마이징**: 사용자가 보고서에 포함할 차트를 선택할 수 있는 옵션 추가.
- **디자인 템플릿**: 회사의 공식 엑셀 템플릿(로고, 헤더 스타일 등) 적용.

---
**작성일**: 2025-12-27
**작성자**: Antigravity (AI Agent)
